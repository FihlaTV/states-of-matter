// Copyright 2014-2017, University of Colorado Boulder

/**
 * This class is used to change the phase state (i.e. solid, liquid, or gas)
 * for a set of water molecules.  It only works for water and would need to be
 * generalized to handle other triatomic molecules.
 *
 * @author John Blanco
 * @author Siddhartha Chinthapally (Actual Concepts)
 */
define( function( require ) {
  'use strict';

  // modules
  var AbstractPhaseStateChanger = require( 'STATES_OF_MATTER/common/model/engine/AbstractPhaseStateChanger' );
  var inherit = require( 'PHET_CORE/inherit' );
  var statesOfMatter = require( 'STATES_OF_MATTER/statesOfMatter' );
  var SOMConstants = require( 'STATES_OF_MATTER/common/SOMConstants' );
  var SubstanceType = require( 'STATES_OF_MATTER/common/SubstanceType' );
  var WaterAtomPositionUpdater = require( 'STATES_OF_MATTER/common/model/engine/WaterAtomPositionUpdater' );

  /**
   * @param { MultipleParticleModel } multipleParticleModel - model of a set of particles
   * @constructor
   */
  function WaterPhaseStateChanger( multipleParticleModel ) {

    // Make sure this is not being used on an inappropriate data set.
    assert && assert( multipleParticleModel.moleculeDataSet.getAtomsPerMolecule() === 3 );

    AbstractPhaseStateChanger.call( this, multipleParticleModel );

    // @private
    this.multipleParticleModel = multipleParticleModel;
    this.positionUpdater = WaterAtomPositionUpdater; // @private
  }

  // Initial positions for liquid phase, which is hard to create algorithmically.  These were created by setting the
  // appropriate temperature and iterating until a visually acceptable configuration emerged, then capturing a
  // "snapshot" of the state.
  var LIQUID_INITIAL_STATES = {
    water: {
      numberOfMolecules: 76,
      atomsPerMolecule: 3,
      moleculeCenterOfMassPositions: [
        { x: 12.381, y: 4.629 },
        { x: 13.644, y: 4.597 },
        { x: 10.621, y: 5.919 },
        { x: 11.376, y: 4.902 },
        { x: 10.669, y: 2.71 },
        { x: 12.132, y: 3.394 },
        { x: 14.683, y: 4.87 },
        { x: 12.912, y: 5.477 },
        { x: 11.272, y: 6.801 },
        { x: 10.322, y: 4.714 },
        { x: 9.201, y: 4.436 },
        { x: 11.122, y: 3.863 },
        { x: 9.581, y: 2.633 },
        { x: 11.684, y: 2.388 },
        { x: 12.844, y: 2.48 },
        { x: 13.237, y: 3.497 },
        { x: 15.372, y: 3.954 },
        { x: 11.908, y: 5.989 },
        { x: 5.837, y: 4.901 },
        { x: 7.994, y: 4.119 },
        { x: 6.868, y: 4.109 },
        { x: 8.679, y: 3.4 },
        { x: 8.531, y: 2.256 },
        { x: 10.043, y: 3.65 },
        { x: 8.134, y: 1.166 },
        { x: 9.22, y: 1.453 },
        { x: 10.303, y: 1.702 },
        { x: 11.345, y: 1.454 },
        { x: 13.96, y: 2.581 },
        { x: 15.151, y: 2.95 },
        { x: 14.386, y: 3.706 },
        { x: 15.801, y: 4.975 },
        { x: 17.221, y: 4.942 },
        { x: 9.662, y: 6.371 },
        { x: 4.505, y: 3.302 },
        { x: 4.53, y: 4.331 },
        { x: 6.494, y: 2.887 },
        { x: 3.225, y: 4.523 },
        { x: 5.492, y: 2.539 },
        { x: 3.494, y: 3.416 },
        { x: 4.329, y: 2.141 },
        { x: 6.293, y: 1.843 },
        { x: 7.402, y: 2.036 },
        { x: 12.408, y: 1.512 },
        { x: 13.67, y: 1.588 },
        { x: 14.839, y: 1.848 },
        { x: 15.926, y: 2.135 },
        { x: 15.563, y: 1.035 },
        { x: 16.548, y: 4.116 },
        { x: 17.583, y: 3.739 },
        { x: 19.331, y: 2.352 },
        { x: 20.358, y: 2.634 },
        { x: 14.971, y: 6.012 },
        { x: 8.141, y: 5.11 },
        { x: 4.012, y: 5.302 },
        { x: 2.359, y: 3.199 },
        { x: 1.254, y: 3.474 },
        { x: 2.535, y: 5.346 },
        { x: 1.809, y: 2.192 },
        { x: 1.747, y: 4.464 },
        { x: 5.192, y: 1.485 },
        { x: 18.711, y: 1.521 },
        { x: 20.718, y: 1.414 },
        { x: 17.618, y: 1.451 },
        { x: 19.32, y: 3.471 },
        { x: 16.263, y: 3.138 },
        { x: 18.588, y: 4.329 },
        { x: 16.63, y: 1.004 },
        { x: 17.292, y: 2.566 },
        { x: 18.395, y: 2.878 },
        { x: 13.943, y: 5.702 },
        { x: 4.231, y: 1.014 },
        { x: 7.052, y: 5.186 },
        { x: 5.659, y: 3.708 },
        { x: 7.56, y: 3.072 },
        { x: 3.007, y: 2.239 }
      ],
      moleculeVelocities: [
        { x: 0.373, y: 0.051 },
        { x: -0.571, y: -0.395 },
        { x: -0.492, y: 0.199 },
        { x: 0.127, y: -0.361 },
        { x: 0.434, y: -0.462 },
        { x: 0.423, y: -0.853 },
        { x: -0.234, y: 0.538 },
        { x: -0.611, y: 0.146 },
        { x: -1.567, y: -0.002 },
        { x: -0.409, y: -0.011 },
        { x: 1.511, y: 0.126 },
        { x: 0.438, y: -0.117 },
        { x: 0.427, y: 0.082 },
        { x: 0.193, y: 0.117 },
        { x: 0.021, y: 0.225 },
        { x: -0.147, y: -0.095 },
        { x: -0.209, y: -0.279 },
        { x: -0.449, y: -0.246 },
        { x: 0.021, y: -0.176 },
        { x: -0.096, y: -0.017 },
        { x: -0.465, y: 0.365 },
        { x: 0.241, y: -0.403 },
        { x: 0.109, y: -0.344 },
        { x: -0.126, y: 0.122 },
        { x: -1.099, y: 0.537 },
        { x: -0.596, y: -0.624 },
        { x: -0.821, y: 0.074 },
        { x: 0.03, y: 0.074 },
        { x: 0.257, y: 0.331 },
        { x: -0.439, y: -0.116 },
        { x: -1.07, y: 0.266 },
        { x: 0.138, y: -0.045 },
        { x: -0.591, y: 0.187 },
        { x: 0.036, y: -0.778 },
        { x: 0.307, y: 1.104 },
        { x: -0.021, y: 0.364 },
        { x: -0.237, y: -0.213 },
        { x: -0.17, y: 0.927 },
        { x: 0.268, y: -0.55 },
        { x: -0.292, y: 0.311 },
        { x: 0.411, y: -0.111 },
        { x: 0.382, y: -0.452 },
        { x: 0.403, y: 0.876 },
        { x: -0.558, y: 0.493 },
        { x: -0.813, y: 0.549 },
        { x: 0.561, y: -0.565 },
        { x: -0.151, y: 0.514 },
        { x: -0.289, y: -0.452 },
        { x: 0.235, y: -0.748 },
        { x: 0.088, y: -0.145 },
        { x: 0.741, y: -0.086 },
        { x: -0.252, y: 0.364 },
        { x: 0.598, y: 0.098 },
        { x: -0.389, y: 1.005 },
        { x: -0.668, y: -0.317 },
        { x: -0.388, y: 0.817 },
        { x: -0.526, y: 0.18 },
        { x: -1.467, y: -0.475 },
        { x: -0.439, y: -0.032 },
        { x: 0.607, y: 0.477 },
        { x: 0.454, y: 0.344 },
        { x: 0.15, y: 1.077 },
        { x: 0.189, y: -0.264 },
        { x: -0.318, y: -0.008 },
        { x: 0.53, y: -0.866 },
        { x: -0.423, y: 0.44 },
        { x: -0.799, y: 0.693 },
        { x: -0.106, y: -0.057 },
        { x: -0.09, y: 0.454 },
        { x: -0.804, y: -0.288 },
        { x: 0.228, y: -0.222 },
        { x: -0.218, y: 0.563 },
        { x: 0.136, y: 0.471 },
        { x: -0.12, y: -0.697 },
        { x: -0.096, y: -1.037 },
        { x: 0.169, y: 0.434 }
      ],
      moleculeRotationAngles: [
        12.805,
        123.089,
        58.338,
        63.025,
        72.404,
        -10.622,
        205.407,
        18.946,
        -77.672,
        -14.116,
        -28.209,
        -70.342,
        37.635,
        -32.728,
        -11.527,
        -38.937,
        14.971,
        31.084,
        6.962,
        -49.052,
        -57.121,
        -2.563,
        49.192,
        -5.476,
        -1.84,
        7.09,
        66.794,
        6.95,
        69.805,
        31.047,
        -0.779,
        30.506,
        -6.769,
        -40.692,
        8.791,
        2.636,
        27.657,
        3.266,
        -67.857,
        -51.805,
        92.818,
        32.2,
        118.768,
        157.334,
        -8.478,
        3.555,
        49.083,
        20.081,
        0.642,
        -46.704,
        -2.321,
        -3.979,
        -4.432,
        25.759,
        34.963,
        -6.046,
        157.014,
        77.427,
        -57.64,
        167.529,
        23.482,
        -121.553,
        -61.884,
        40.848,
        -29.722,
        -10.783,
        80.473,
        -152.244,
        54.338,
        131.093,
        -121.152,
        -68.659,
        44.016,
        42.909,
        -18.756,
        80.224,
        0
      ],
      moleculeRotationRates: [
        1.592,
        -1.442,
        4.671,
        1.467,
        -0.557,
        2.068,
        -8.402,
        1.149,
        4.407,
        -4.364,
        0.021,
        3.816,
        1.63,
        -1.759,
        -2.255,
        0.682,
        3.986,
        4.409,
        -1.634,
        -0.42,
        -0.598,
        3.368,
        1.427,
        -1.359,
        2.474,
        3.066,
        -1.835,
        0.244,
        -1.4,
        3.087,
        -0.541,
        -3.417,
        1.426,
        4.243,
        -0.69,
        -2.112,
        -1.158,
        2.977,
        -1.133,
        -3.352,
        1.253,
        4.739,
        3.819,
        -0.367,
        3.733,
        0.024,
        0.723,
        -1.58,
        -2.568,
        4.397,
        -0.713,
        -2.843,
        -5.799,
        -1.408,
        2.166,
        -2.875,
        -0.416,
        -3.883,
        -1.764,
        4.495,
        3.638,
        -2.584,
        -3.613,
        1.849,
        -3.144,
        0.758,
        3.722,
        -2.056,
        -1.215,
        -1.665,
        -1.658,
        2.764,
        0.927,
        0.223,
        0.699,
        1.853,
        0
      ]
    }
  };
  var SOLID_INITIAL_STATES = {
    water: {
      numberOfMolecules: 76,
      atomsPerMolecule: 3,

      moleculeCenterOfMassPositions:
        [
          { x: 3.874, y: 1.433 },
          { x: 5.080, y: 1.746 },
          { x: 6.210, y: 2.301 },
          { x: 7.408, y: 2.118 },
          { x: 13.039, y: 1.174 },
          { x: 15.508, y: 1.677 },
          { x: 16.567, y: 2.343 },
          { x: 19.344, y: 4.448 },
          { x: 4.946, y: 3.072 },
          { x: 6.107, y: 3.512 },
          { x: 7.927, y: 3.389 },
          { x: 8.586, y: 2.381 },
          { x: 14.291, y: 1.632 },
          { x: 14.069, y: 2.875 },
          { x: 15.305, y: 2.943 },
          { x: 18.320, y: 3.791 },
          { x: 4.143, y: 5.242 },
          { x: 4.981, y: 4.306 },
          { x: 7.037, y: 4.307 },
          { x: 9.796, y: 2.304 },
          { x: 11.813, y: 2.060 },
          { x: 12.947, y: 2.450 },
          { x: 16.719, y: 3.611 },
          { x: 17.733, y: 2.761 },
          { x: 4.072, y: 6.483 },
          { x: 5.612, y: 5.297 },
          { x: 9.040, y: 3.745 },
          { x: 10.913, y: 2.812 },
          { x: 12.049, y: 3.235 },
          { x: 14.367, y: 4.173 },
          { x: 16.514, y: 5.048 },
          { x: 17.782, y: 4.915 },
          { x: 4.632, y: 7.512 },
          { x: 5.327, y: 6.491 },
          { x: 6.842, y: 5.564 },
          { x: 9.503, y: 4.869 },
          { x: 10.486, y: 4.021 },
          { x: 13.158, y: 4.270 },
          { x: 15.618, y: 4.158 },
          { x: 17.473, y: 6.095 },
          { x: 6.603, y: 7.350 },
          { x: 7.695, y: 6.596 },
          { x: 8.835, y: 6.141 },
          { x: 10.167, y: 5.899 },
          { x: 11.641, y: 4.449 },
          { x: 14.544, y: 5.422 },
          { x: 15.670, y: 5.975 },
          { x: 16.588, y: 6.921 },
          { x: 5.612, y: 8.160 },
          { x: 7.693, y: 7.871 },
          { x: 8.830, y: 8.126 },
          { x: 9.590, y: 7.046 },
          { x: 11.433, y: 5.990 },
          { x: 12.642, y: 5.428 },
          { x: 14.662, y: 7.112 },
          { x: 15.742, y: 7.796 },
          { x: 6.377, y: 9.159 },
          { x: 7.655, y: 9.102 },
          { x: 10.373, y: 7.943 },
          { x: 11.426, y: 7.170 },
          { x: 12.700, y: 6.953 },
          { x: 13.617, y: 6.198 },
          { x: 14.781, y: 8.687 },
          { x: 14.755, y: 9.935 },
          { x: 6.119, y: 10.354 },
          { x: 7.415, y: 10.256 },
          { x: 8.798, y: 9.804 },
          { x: 9.866, y: 9.192 },
          { x: 11.631, y: 8.385 },
          { x: 12.935, y: 8.154 },
          { x: 13.583, y: 9.189 },
          { x: 13.703, y: 10.596 },
          { x: 8.215, y: 11.219 },
          { x: 9.429, y: 10.862 },
          { x: 10.664, y: 10.816 },
          { x: 11.021, y: 9.567 }
        ],
      moleculeVelocities:
        [
          { x: -0.407, y: 0.144 },
          { x: -0.434, y: -0.107 },
          { x: 0.093, y: 0.083 },
          { x: 0.571, y: -0.379 },
          { x: -0.392, y: -0.324 },
          { x: 0.312, y: 0.023 },
          { x: 0.416, y: -0.471 },
          { x: -0.466, y: -0.394 },
          { x: -0.563, y: -0.139 },
          { x: -0.457, y: 0.526 },
          { x: -0.710, y: -0.101 },
          { x: 0.049, y: -0.256 },
          { x: -0.035, y: 1.018 },
          { x: -0.176, y: 0.093 },
          { x: 0.777, y: -0.195 },
          { x: -0.291, y: 0.587 },
          { x: -0.515, y: -0.095 },
          { x: 0.004, y: 0.061 },
          { x: -0.010, y: -0.190 },
          { x: 0.108, y: -0.188 },
          { x: 0.088, y: -0.384 },
          { x: 0.153, y: 0.493 },
          { x: 0.493, y: 0.488 },
          { x: 0.250, y: 0.053 },
          { x: 0.120, y: -0.087 },
          { x: -0.390, y: 0.184 },
          { x: -0.046, y: 0.187 },
          { x: 0.130, y: 0.021 },
          { x: -0.231, y: 0.044 },
          { x: 0.431, y: 0.023 },
          { x: -0.685, y: 0.385 },
          { x: 0.514, y: -0.186 },
          { x: 0.064, y: 0.088 },
          { x: -0.027, y: -0.295 },
          { x: 0.220, y: 0.202 },
          { x: 0.378, y: -0.053 },
          { x: 0.182, y: -0.347 },
          { x: -0.208, y: 0.102 },
          { x: 0.304, y: -0.165 },
          { x: -0.351, y: 0.040 },
          { x: -0.065, y: -0.659 },
          { x: -0.343, y: 0.444 },
          { x: -0.339, y: -0.103 },
          { x: -0.114, y: 0.072 },
          { x: -0.005, y: 0.034 },
          { x: 0.043, y: 0.125 },
          { x: -0.059, y: -0.208 },
          { x: -0.265, y: 0.224 },
          { x: 0.069, y: 0.252 },
          { x: -0.523, y: 0.354 },
          { x: 0.573, y: -0.233 },
          { x: 0.722, y: 0.147 },
          { x: -0.049, y: 0.210 },
          { x: -0.473, y: 0.215 },
          { x: 0.242, y: -0.153 },
          { x: -0.252, y: 0.092 },
          { x: 0.144, y: 0.276 },
          { x: 0.823, y: -0.634 },
          { x: -0.557, y: -0.352 },
          { x: -0.185, y: 0.248 },
          { x: 0.349, y: -0.262 },
          { x: 0.353, y: -0.395 },
          { x: 0.884, y: -0.048 },
          { x: 0.716, y: 0.101 },
          { x: -0.759, y: 0.559 },
          { x: -0.170, y: 0.407 },
          { x: -0.071, y: -0.542 },
          { x: 0.076, y: 0.635 },
          { x: -0.230, y: -0.229 },
          { x: -0.121, y: 0.116 },
          { x: 0.796, y: 0.016 },
          { x: -0.531, y: 0.871 },
          { x: 0.003, y: -0.104 },
          { x: 0.057, y: -0.166 },
          { x: -0.377, y: -0.077 },
          { x: 0.571, y: 0.348 }
        ],
      moleculeRotationAngles:
        [
          0.207,
          6.689,
          5.758,
          6.345,
          8.142,
          3.650,
          1.827,
          3.846,
          4.282,
          1.016,
          4.175,
          6.222,
          7.921,
          6.678,
          5.127,
          4.269,
          3.487,
          4.426,
          5.753,
          0.350,
          0.057,
          6.662,
          6.472,
          3.748,
          4.820,
          4.475,
          1.132,
          -0.164,
          5.830,
          3.382,
          6.192,
          -0.879,
          4.050,
          -1.253,
          1.044,
          1.021,
          2.719,
          2.557,
          0.900,
          5.182,
          2.615,
          6.318,
          4.672,
          0.263,
          1.287,
          4.691,
          7.617,
          5.752,
          1.292,
          3.957,
          3.314,
          4.392,
          5.683,
          7.027,
          6.731,
          -0.476,
          5.793,
          4.785,
          1.829,
          2.024,
          3.278,
          6.002,
          3.397,
          4.890,
          6.556,
          4.827,
          1.206,
          3.098,
          6.326,
          4.686,
          1.922,
          6.051,
          3.982,
          -0.023,
          -1.148,
          3.627
        ],
      moleculeRotationRates:
        [
          0.977,
          2.893,
          -1.768,
          -0.835,
          0.557,
          -1.753,
          -2.949,
          -1.285,
          -0.566,
          -2.318,
          0.360,
          -0.140,
          4.042,
          -1.451,
          -2.264,
          -2.788,
          -1.068,
          -0.907,
          0.202,
          0.229,
          1.462,
          1.327,
          -1.572,
          1.655,
          -0.231,
          -1.546,
          1.631,
          2.410,
          1.728,
          0.592,
          2.865,
          0.798,
          -1.507,
          0.742,
          1.012,
          1.263,
          1.274,
          -0.399,
          0.613,
          1.373,
          0.141,
          1.984,
          0.555,
          0.523,
          0.553,
          -0.621,
          -1.006,
          -0.197,
          -1.489,
          0.507,
          -0.524,
          2.999,
          2.848,
          -3.521,
          -2.364,
          2.222,
          -2.754,
          0.165,
          2.348,
          0.311,
          0.344,
          -0.720,
          2.166,
          4.194,
          0.143,
          -3.364,
          3.347,
          0.409,
          -2.668,
          -0.739,
          1.892,
          0.350,
          4.353,
          -0.912,
          0.274,
          -0.381
        ]

    }


  };

  //================================================================


  statesOfMatter.register( 'WaterPhaseStateChanger', WaterPhaseStateChanger );

  return inherit( AbstractPhaseStateChanger, WaterPhaseStateChanger, {

    /**
     * @public
     * @param {number} phaseID - state(solid/liquid/gas) of Molecule
     */
    setPhase: function( phaseID ) {

      AbstractPhaseStateChanger.prototype.setPhase.call( this, phaseID );

      // Sync up the atom positions with the molecule positions.
      this.positionUpdater.updateAtomPositions( this.multipleParticleModel.moleculeDataSet );

      // Step the model a number of times in order to prevent the particles from looking too organized.  The number of
      // steps was empirically determined.
      for ( var i = 0; i < 5; i++ ) {
        this.multipleParticleModel.stepInternal( SOMConstants.NOMINAL_TIME_STEP );
      }
    },

    /**
     * Set the phase to the solid state.
     * @protected
     */
    setPhaseSolid: function() {

      var dataSetToLoad;

      // find the data for this substance
      if ( this.multipleParticleModel.substanceProperty.get() === SubstanceType.WATER ) {
        dataSetToLoad = SOLID_INITIAL_STATES.water;
      }
      assert && assert( dataSetToLoad, 'unhandled substance: ' + this.multipleParticleModel.substanceProperty.get() );

      // load the previously saved state
      this.loadSavedState( dataSetToLoad );

      // set the temperature
      this.multipleParticleModel.setTemperature( SOMConstants.SOLID_TEMPERATURE );
    },

    /**
     * Set the phase to the liquid state.
     * @protected
     */
    setPhaseLiquid: function() {

      var dataSetToLoad;

      // find the data for this substance
      if ( this.multipleParticleModel.substanceProperty.get() === SubstanceType.WATER ) {
        dataSetToLoad = LIQUID_INITIAL_STATES.water;
      }
      assert && assert( dataSetToLoad, 'unhandled substance: ' + this.multipleParticleModel.substanceProperty.get() );

      // load the previously saved state
      this.loadSavedState( dataSetToLoad );

      // set the temperature
      this.multipleParticleModel.setTemperature( SOMConstants.LIQUID_TEMPERATURE );
    }
  } );
} );
